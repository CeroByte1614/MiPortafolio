import streamlit as st
import base64
import os
import time

# --- 1. CONFIGURACI√ìN Y FUNCIONES ---
st.set_page_config(
    page_title="Carlos Soto | Portfolio", 
    page_icon="üõ°Ô∏è", 
    layout="wide", 
    initial_sidebar_state="collapsed"
)

def get_base64(bin_file):
    if os.path.exists(bin_file):
        with open(bin_file, 'rb') as f:
            data = f.read()
        return base64.b64encode(data).decode()
    return None

# --- 2. CARGA DE RECURSOS ---
ruta_base = os.path.dirname(__file__)
bg_img = get_base64('imagenciberseguridad.jpg')
perfil_img = get_base64('imagencarlos.jpeg')
bg_card_img = get_base64('imagenciberseguridad2.jpg')
icon_habilidades_img = get_base64(os.path.join(ruta_base, 'iconohabilidades.png'))

# --- 3. DATOS ---
experiencias = [
    {
        "titulo": "Service Desk Analyst | Vector (Salcobrand)",
        "periodo": "07/2023 - Presente",
        "puntos": [
            "IAM: Administraci√≥n de identidades y accesos en Azure AD (Entra ID) y Directorio Activo.",
            "Seguridad de Endpoints: Gesti√≥n de pol√≠ticas, antivirus y conectividad segura v√≠a VPN (SSL/IPsec).",
            "Hardening: Endurecimiento de sistemas y restricci√≥n de software mediante GPOs.",
            "Respuesta a Incidentes: Triaje y resoluci√≥n de incidentes de seguridad (N1/N2) bajo SLA.",
            "Gesti√≥n de Activos: Control de inventario para trazabilidad y mitigaci√≥n de uso no autorizado de hardware."
        ]
    },
    {
        "titulo": "Soporte T√©cnico e Infraestructura IT | UpcomDTS",
        "periodo": "02/2023 - 07/2023",
        "puntos": [
            "Administraci√≥n de Seguridad Microsoft 365: Configuraci√≥n de controles de acceso y gesti√≥n de identidades en entornos h√≠bridos.",
            "Seguridad de Red: Implementaci√≥n de accesos remotos seguros v√≠a VPN y monitoreo b√°sico de conectividad.",
            "Soporte a la Disponibilidad: Mantenimiento preventivo y correctivo de hardware y software para garantizar la continuidad del negocio."
        ]
    },
    {
        "titulo": "Encargado de computaci√≥n | Red de colegios SIP",
        "periodo": "01/2022 - 01/2023",
        "puntos": [
            "Seguridad y Redes: Configuraci√≥n de Firewalls, Switches (L2/L3) y segmentaci√≥n de red segura.",
            "Monitoreo: Detecci√≥n de anomal√≠as y an√°lisis de tr√°fico mediante herramientas de sniffing.",
            "Infraestructura: Gesti√≥n integral de Data Center, Racks y respaldo el√©ctrico (UPS).",
            "Control de Acceso: Gesti√≥n de usuarios y filtrado de contenido seg√∫n normativas de seguridad."
        ]
    }
]

habilidades = {
    "Pentesting & Ethical Hacking": "Uso de herramientas como Metasploit, Nmap y Burp Suite para identificar vulnerabilidades.",
    "Hardening de Sistemas": "Endurecimiento de servidores y estaciones de trabajo bajo mejores pr√°cticas de seguridad.",
    "OWASP Top 10": "Mitigaci√≥n de los riesgos de seguridad m√°s cr√≠ticos en aplicaciones web.",
    "Criptograf√≠a": "Implementaci√≥n de algoritmos y protocolos como PKI, AES y RSA.",
    "Gesti√≥n de Vulnerabilidades": "Identificaci√≥n, clasificaci√≥n y priorizaci√≥n de brechas mediante Nessus.",
    "Active Directory & Azure AD": "Administraci√≥n avanzada de identidades, Entra ID y servicios de dominio.",
    "Networking & Protocolos": "Gesti√≥n de TCP/IP, segmentaci√≥n VLANs, enrutamiento OSPF y t√∫neles VPN SSL/IPsec.",
    "Firewalling": "Configuraci√≥n y administraci√≥n de reglas de seguridad perimetral.",
    "Linux (Ubuntu/Debian)": "Administraci√≥n avanzada de sistemas, personalizaci√≥n de entorno y Bash scripting.",
    "Windows Server": "Gesti√≥n de infraestructura de servidores en entornos Windows.",
    "An√°lisis de Tr√°fico": "Captura y diagn√≥stico de paquetes de red mediante Wireshark.",
    "Docker & Virtualizaci√≥n": "Despliegue de contenedores y gesti√≥n de m√°quinas virtuales con VMware.",
    "Python para Seguridad": "Desarrollo de scripts para automatizaci√≥n de tareas y herramientas de seguridad.",
    "SQL": "Gesti√≥n de bases de datos relacionales y consultas.",
    "Normativas y Frameworks": "Conocimiento acad√©mico en ISO 27001 y NIST Cybersecurity Framework."
}

# --- 4. L√ìGICA DE SESI√ìN ---
if 'exp_index' not in st.session_state:
    st.session_state.exp_index = 0
if 'last_refresh' not in st.session_state:
    st.session_state.last_refresh = time.time()

if time.time() - st.session_state.last_refresh > 15:
    st.session_state.exp_index = (st.session_state.exp_index + 1) % len(experiencias)
    st.session_state.last_refresh = time.time()
    st.rerun()

# --- 5. ESTILOS CSS ---
st.markdown(f"""
    <style>
    header {{visibility: hidden;}}
    .main .block-container {{ padding-top: 0rem; padding-bottom: 0rem; }}
    #MainMenu, footer {{visibility: hidden;}}
    .stApp {{
        background-image: linear-gradient(rgba(5, 10, 48, 0.95), rgba(0, 0, 0, 0.95)), url("data:image/png;base64,{bg_img}");
        background-size: 140% 140%; /* Un poco m√°s grande para que el movimiento sea fluido */
        background-repeat: no-repeat;
        color: white !important;
        animation: moveBackground 30s ease-in-out infinite; /* 30 segundos para que sea muy sutil */
    }}
    .social-header {{ position: absolute; top: 10px; right: 30px; display: flex; gap: 20px; z-index: 999; align-items: center; }}
    .cv-title {{ position: absolute; top: 10px; left: 30px; color: white; font-weight: bold; font-size: 18px; z-index: 999; }}
    .icon-white {{ width: 30px; filter: brightness(0) invert(1); transition: transform 0.3s ease; }}
    .icon-white:hover {{ transform: scale(1.3); filter: brightness(0) invert(1) drop-shadow(0 0 10px #00f2ff); }}
    .profile-pic {{
        width: 150px; height: 150px; border-radius: 50%; object-fit: cover;
        border: 4px solid #00f2ff; box-shadow: 0 0 20px #00f2ff; display: block; margin: auto;
    }}
    .perfil-texto {{ 
        max-width: 850px; margin: 20px auto; text-align: center; font-size: 18px; color: white; 
        transition: transform 0.4s ease; /* Permite que el zoom sea fluido */
    }}
    .perfil-texto:hover {{ 
        transform: scale(1.05); /* Aplica el zoom del 5% */
    }}
    @keyframes moveBackground {{
        0% {{ background-position: 0% 50%; }}
        50% {{ background-position: 100% 50%; }}
        100% {{ background-position: 0% 50%; }}
    }}
    @keyframes fadeIn {{
        0% {{ opacity: 0; }}
        100% {{ opacity: 1; }}
    }}
    @keyframes slideIn {{ 0% {{ transform: translateX(100px); opacity: 0; }} 100% {{ transform: translateX(0); opacity: 1; }} }}
    .exp-card {{
        background-image: linear-gradient(rgba(17, 34, 64, 0.85), rgba(17, 34, 64, 0.85)), url("data:image/jpg;base64,{bg_card_img if bg_card_img else ''}");
        background-size: cover; background-position: center; padding: 40px; border-radius: 20px;
        border: 2px solid rgba(0, 242, 255, 0.3); min-height: 420px; backdrop-filter: blur(12px);
        animation: slideIn 0.8s ease-out, fadeIn 1.2s ease-out;
    }}
    .exp-card:hover {{
        transform: scale(1.03); border: 2px solid #00f2ff; box-shadow: 0 0 35px rgba(0, 242, 255, 0.5);
        background-image: linear-gradient(rgba(17, 34, 64, 0.75), rgba(17, 34, 64, 0.75)), url("data:image/jpg;base64,{bg_card_img if bg_card_img else ''}");
    }}
    .skill-tag {{
        background: rgba(0, 242, 255, 0.1); border: 1px solid #00f2ff; padding: 6px 14px; 
        border-radius: 15px; display: inline-block; margin: 5px; font-size: 14px;
        position: relative; cursor: pointer; color: white !important; font-weight: bold !important; transition: all 0.3s ease;
    }}
    .skill-tag:hover {{ background: rgba(0, 242, 255, 0.3); transform: translateY(-2px); box-shadow: 0 0 10px rgba(0, 242, 255, 0.5); }}
    .skill-tag:hover::after {{
        content: attr(data-description); position: absolute; bottom: 125%; left: 50%; transform: translateX(-50%);
        background: rgba(255, 255, 255, 0.95); color: #050a30; padding: 10px; border-radius: 8px; width: 200px;
        font-size: 12px; font-weight: bold; text-align: center; z-index: 1000; box-shadow: 0 0 15px rgba(0, 242, 255, 0.6);
        border: 1px solid #00f2ff; white-space: normal; line-height: 1.4;
    }}
    div.stButton > button {{
        background-color: transparent !important; 
        border: none !important; 
        color: #00f2ff !important;
        font-size: 24px !important; 
        font-weight: bold !important; 
        transition: all 0.3s ease !important; 
        width: 100%;
        outline: none !important;
    }}

    div.stButton > button:hover, 
    div.stButton > button:active {{ 
        transform: scale(1.15) !important; 
        color: white !important; 
        text-shadow: 0 0 15px #00f2ff !important;
        background-color: transparent !important; 
    }}

    div.stButton > button:focus {{
        color: #00f2ff !important;
        box-shadow: none !important;
        outline: none !important;
    }}
    h1, h2, h3 {{ color: #00f2ff !important; font-family: 'Segoe UI', sans-serif; }}
    </style>
    """, unsafe_allow_html=True)

# --- 6. NAVEGACI√ìN Y HEADER ---
st.markdown(f"""
<div class="cv-title">Mi Curriculum Vitae</div>
<div class="social-header">
    <a href="https://www.linkedin.com/in/carlos-e-soto-v%C3%A1squez-8366b3241" target="_blank">
        <img src="https://cdn-icons-png.flaticon.com/512/174/174857.png" style="width:30px;" class="icon-color-hover">
    </a>
    <a href="mailto:sotovasquezcarlos1614@gmail.com">
        <img src="https://upload.wikimedia.org/wikipedia/commons/7/7e/Gmail_icon_%282020%29.svg" style="width:30px;" class="icon-color-hover">
    </a>
    <a href="https://www.instagram.com/" target="_blank">
        <img src="https://cdn-icons-png.flaticon.com/512/174/174855.png" style="width:30px;" class="icon-color-hover">
    </a>
    <a href="https://www.facebook.com/" target="_blank">
        <img src="https://upload.wikimedia.org/wikipedia/commons/b/b9/2023_Facebook_icon.svg" style="width:30px;" class="icon-color-hover">
    </a>
</div>
<style>
    /* Nueva clase para iconos con color que mantiene el efecto de crecer */
    .icon-color-hover {{
        transition: transform 0.3s ease;
    }}
    .icon-color-hover:hover {{
        transform: scale(1.3);
        filter: drop-shadow(0 0 8px rgba(0, 242, 255, 0.8));
    }}
</style>
""", unsafe_allow_html=True)

if perfil_img:
    st.markdown(f'<img src="data:image/jpeg;base64,{perfil_img}" class="profile-pic">', unsafe_allow_html=True)

st.markdown("<h1 style='text-align: center; margin-bottom: 0;'>CARLOS ENRIQUE SOTO V√ÅSQUEZ</h1>", unsafe_allow_html=True)
st.markdown("<p style='text-align: center; color: #00f2ff; font-size: 22px; font-weight: bold;'>Estudiante de Ingenier√≠a en Ciberseguridad y Auditor√≠a Inform√°tica</p>", unsafe_allow_html=True)

# --- TEXTO DE PERFIL RESTAURADO COMPLETO ---
st.markdown('<div class="perfil-texto">Estudiante de Ingenier√≠a en Ciberseguridad con 26 a√±os de edad cuento con m√°s de 4 a√±os de experiencia en soporte t√©cnico, infraestructura TI y administraci√≥n de identidades (IAM). Especializado en el endurecimiento de sistemas (Hardening), gesti√≥n de redes bajo modelo OSI y respuesta a incidentes N1/N2. S√≥lidos conocimientos en seguridad ofensiva y defensiva, con capacidad para implementar soluciones t√©cnicas que aseguren la continuidad operativa y la protecci√≥n de activos cr√≠ticos bajo est√°ndares de cumplimiento y SLA.</div>', unsafe_allow_html=True)

st.markdown("---")

# --- 7. SECCI√ìN EXPERIENCIA ---
col_prev, col_card, col_next = st.columns([1.5, 7, 1.5], vertical_alignment="center")

with col_prev:
    st.markdown('<div style="text-align: right;">', unsafe_allow_html=True)
    if st.button("‚ùÆ Anterior", key="prev_btn"):
        st.session_state.exp_index = (st.session_state.exp_index - 1) % len(experiencias)
        st.session_state.last_refresh = time.time()
        st.rerun()
    st.markdown('</div>', unsafe_allow_html=True)

with col_card:
    exp = experiencias[st.session_state.exp_index]
    puntos_html = "".join([f"<li>{p}</li>" for p in exp['puntos']])
    
    # Creamos un contenedor con una clave √∫nica (st.session_state.exp_index)
    # Esto fuerza a la p√°gina a reiniciar la animaci√≥n CSS al cambiar de tarjeta
    st.container(key=f"card_{st.session_state.exp_index}").markdown(f"""
    <div class="exp-card">
        <h2 style='text-align: left;'>{exp['titulo']}</h2>
        <p style='color:#00f2ff; font-size: 18px; text-align: left;'><b>{exp['periodo']}</b></p>
        <ul style='font-size: 17px; line-height: 1.6; color: #f0f0f0; text-align: left;'>{puntos_html}</ul>
    </div>
    """, unsafe_allow_html=True)

with col_next:
    st.markdown('<div style="text-align: left; white-space: nowrap;">', unsafe_allow_html=True)
    if st.button("Siguiente ‚ùØ", key="next_btn"):
        st.session_state.exp_index = (st.session_state.exp_index + 1) % len(experiencias)
        st.session_state.last_refresh = time.time()
        st.rerun()
    st.markdown('</div>', unsafe_allow_html=True)

# --- 8. EDUCACI√ìN Y HABILIDADES ---
st.markdown("---")
c1, c2 = st.columns(2)

with c1:
    st.markdown(f"""
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
                <img src="https://cdn-icons-png.flaticon.com/512/3135/3135810.png" width="40" height="40" style="filter: brightness(0) invert(1) drop-shadow(0 0 5px #00f2ff);">
                <span style="color: #00f2ff; font-size: 28px; font-weight: bold; font-family: 'Segoe UI', sans-serif;">Educaci√≥n</span>
            </div>
        """, unsafe_allow_html=True)
    st.write("**Ingenier√≠a en Ciberseguridad y Auditor√≠a Inform√°tica**")
    st.write("Universidad San Sebasti√°n (03/2022 - Presente)")
    st.markdown("<br>", unsafe_allow_html=True)
    st.markdown(f"""
            <div style="display: flex; align-items: center; gap: 12px; margin-top: 20px; margin-bottom: 10px;">
                <img src="https://cdn-icons-png.flaticon.com/512/2436/2436633.png" width="40" height="40" style="filter: brightness(0) invert(1) drop-shadow(0 0 5px #00f2ff);">
                <span style="color: #00f2ff; font-size: 28px; font-weight: bold; font-family: 'Segoe UI', sans-serif;">Certificados y Cursos</span>
            </div>
        """, unsafe_allow_html=True)
    certificados = ["NSE 1, 2 y 3 Fortinet", "Cisco Certified Network Associate (CCNA)", "Conceptos b√°sicos de redes", "Introducci√≥n a la Ciberseguridad", "Personalizaci√≥n de entorno en Linux", "Licencia de conducir clase B"]
    for cert in certificados:
        st.write(f"‚Ä¢ {cert}")

with c2:
    icono_datos = icon_habilidades_img if icon_habilidades_img else ""
    st.markdown(f"""
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
          <img src="https://cdn-icons-png.flaticon.com/512/2092/2092663.png" width="45" height="45" style="vertical-align: middle; filter: brightness(0) invert(1) drop-shadow(0 0 5px #00f2ff);">
            <span style="color: #00f2ff; font-size: 28px; font-weight: bold;">Habilidades T√©cnicas</span>
        </div>
    """, unsafe_allow_html=True)
    
    html_habilidades = "".join([f'<span class="skill-tag" data-description="{desc}">{nombre}</span> ' for nombre, desc in habilidades.items()])
    st.markdown(html_habilidades, unsafe_allow_html=True)
